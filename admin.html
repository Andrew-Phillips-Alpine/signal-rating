<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alpine Signal - Lead Magnet Submissions</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0a1628 0%, #1a2332 100%);
            color: #e0e7ff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #00d4ff;
        }

        h1 {
            color: #00d4ff;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            padding: 20px;
        }

        .stat-label {
            font-size: 14px;
            color: #a0aec0;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #00d4ff;
        }

        .filters {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 12px;
            color: #a0aec0;
        }

        select, input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid #00d4ff;
            color: #e0e7ff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #00d4ff;
            color: #0a1628;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        button:hover {
            background: #00b8e6;
            transform: translateY(-2px);
        }

        .submissions-table {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #00d4ff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(0, 212, 255, 0.2);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #00d4ff;
            border-bottom: 2px solid #00d4ff;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 212, 255, 0.1);
        }

        tr:hover {
            background: rgba(0, 212, 255, 0.05);
        }

        .score {
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .score-high { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .score-medium { background: rgba(234, 179, 8, 0.2); color: #fbbf24; }
        .score-low { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        .email-badge {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: inline-block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #00d4ff;
        }

        .export-btn {
            background: #fbbf24;
            margin-left: auto;
        }

        .export-btn:hover {
            background: #f59e0b;
        }

        .detail-row {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 4px;
        }

        .patterns {
            font-size: 12px;
            color: #fbbf24;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Lead Magnet Submissions Dashboard</h1>
            <p>Track and analyze all Alpine Signal Rating submissions</p>
            <p style="font-size: 14px; color: #00d4ff; margin-top: 5px;">üì° Viewing: <strong id="dataSource">Loading...</strong></p>
        </header>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-label">Total Submissions</div>
                <div class="stat-value" id="totalSubmissions">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">With Email</div>
                <div class="stat-value" id="withEmail">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Avg AIS Score</div>
                <div class="stat-value" id="avgScore">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Last 7 Days</div>
                <div class="stat-value" id="recentSubmissions">-</div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Sector</label>
                <select id="sectorFilter">
                    <option value="">All Sectors</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ARR</label>
                <select id="arrFilter">
                    <option value="">All ARR</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date Range</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <input type="date" id="endDate">
            </div>
            <button onclick="applyFilters()">Apply Filters</button>
            <button class="export-btn" onclick="exportToCSV()">Export CSV</button>
        </div>

        <div class="submissions-table">
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Company</th>
                        <th>Email</th>
                        <th>Cohort</th>
                        <th>AIS Score</th>
                        <th>Scores Breakdown</th>
                        <th>Top Challenge</th>
                    </tr>
                </thead>
                <tbody id="submissionsTable">
                    <tr>
                        <td colspan="7" class="loading">Loading submissions...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allSubmissions = [];

        // Configuration: set to production URL or leave empty for local
        const API_BASE_URL = 'https://signal.thealpinesystem.com';

        // Load submissions on page load
        async function loadSubmissions() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/submissions`);
                if (!response.ok) throw new Error('Failed to fetch submissions');

                const data = await response.json();
                allSubmissions = data.submissions || data;

                // Normalize old data format (patterns as objects) to new format (patterns as strings)
                allSubmissions = allSubmissions.map(sub => {
                    if (sub.patterns && sub.patterns.length > 0 && typeof sub.patterns[0] === 'object') {
                        sub.patterns = sub.patterns.map(p => p.pattern || p);
                    }
                    // Ensure client_name and email exist
                    if (!sub.client_name) sub.client_name = 'Unknown';
                    if (!sub.email) sub.email = '';
                    return sub;
                });

                // Sort by timestamp (newest first)
                allSubmissions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                // Update data source indicator
                document.getElementById('dataSource').textContent = API_BASE_URL || 'Local Server (http://localhost:3000)';

                updateStats();
                populateFilters();
                renderTable(allSubmissions);
            } catch (error) {
                console.error('Error loading submissions:', error);
                document.getElementById('submissionsTable').innerHTML =
                    '<tr><td colspan="7" style="text-align: center; color: #f87171;">Error loading submissions. Make sure the server is running.</td></tr>';
            }
        }

        function updateStats() {
            const total = allSubmissions.length;
            const withEmail = allSubmissions.filter(s => s.email && s.email.length > 0).length;
            const avgScore = allSubmissions.length > 0
                ? (allSubmissions.reduce((sum, s) => sum + (s.scores.overall_ssi || 0), 0) / total * 100).toFixed(1)
                : 0;

            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const recent = allSubmissions.filter(s => new Date(s.timestamp) > sevenDaysAgo).length;

            document.getElementById('totalSubmissions').textContent = total;
            document.getElementById('withEmail').textContent = withEmail;
            document.getElementById('avgScore').textContent = avgScore + '%';
            document.getElementById('recentSubmissions').textContent = recent;
        }

        function populateFilters() {
            // Populate sector filter
            const sectors = [...new Set(allSubmissions.map(s => s.sector).filter(s => s && s !== 'unknown'))];
            const sectorFilter = document.getElementById('sectorFilter');
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector;
                option.textContent = sector;
                sectorFilter.appendChild(option);
            });

            // Populate ARR filter
            const arrs = [...new Set(allSubmissions.map(s => s.cohort).filter(a => a && a !== 'unknown'))];
            const arrFilter = document.getElementById('arrFilter');
            arrs.forEach(arr => {
                const option = document.createElement('option');
                option.value = arr;
                option.textContent = arr;
                arrFilter.appendChild(option);
            });
        }

        function applyFilters() {
            const sector = document.getElementById('sectorFilter').value;
            const arr = document.getElementById('arrFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let filtered = allSubmissions;

            if (sector) {
                filtered = filtered.filter(s => s.sector === sector);
            }

            if (arr) {
                filtered = filtered.filter(s => s.cohort === arr);
            }

            if (startDate) {
                filtered = filtered.filter(s => new Date(s.timestamp) >= new Date(startDate));
            }

            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filtered = filtered.filter(s => new Date(s.timestamp) <= end);
            }

            renderTable(filtered);
        }

        function renderTable(submissions) {
            const tbody = document.getElementById('submissionsTable');

            if (submissions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #a0aec0;">No submissions found</td></tr>';
                return;
            }

            tbody.innerHTML = submissions.map(sub => {
                const date = new Date(sub.timestamp).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const aisScore = (sub.scores.overall_ssi * 100).toFixed(0);
                const scoreClass = aisScore >= 70 ? 'score-high' : aisScore >= 40 ? 'score-medium' : 'score-low';

                return `
                    <tr>
                        <td>${date}</td>
                        <td>
                            <strong>${sub.client_name || 'Unknown'}</strong>
                            <div class="detail-row">${sub.employees || 'N/A'} employees</div>
                        </td>
                        <td>
                            ${sub.email ? `<span class="email-badge">${sub.email}</span>` : '<span style="color: #a0aec0;">Not provided</span>'}
                        </td>
                        <td>
                            <strong>${sub.sector || 'Unknown'}</strong>
                            <div class="detail-row">ARR: ${sub.cohort || 'N/A'}</div>
                        </td>
                        <td>
                            <span class="score ${scoreClass}">${aisScore}%</span>
                        </td>
                        <td>
                            <div>Pipeline: ${(sub.scores.pipeline * 100).toFixed(0)}%</div>
                            <div>Conversion: ${(sub.scores.conversion * 100).toFixed(0)}%</div>
                            <div>Expansion: ${(sub.scores.expansion * 100).toFixed(0)}%</div>
                        </td>
                        <td>
                            ${sub.answers.top_challenge || 'N/A'}
                            ${sub.patterns && sub.patterns.length > 0 ? `
                                <div class="patterns">‚ö†Ô∏è ${sub.patterns.length} pattern(s) detected</div>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function exportToCSV() {
            const headers = ['Date', 'Company', 'Email', 'Sector', 'ARR', 'Employees', 'AIS Score', 'Pipeline', 'Conversion', 'Expansion', 'Top Challenge', 'Patterns'];

            const rows = allSubmissions.map(sub => [
                new Date(sub.timestamp).toISOString(),
                sub.client_name || '',
                sub.email || '',
                sub.sector || '',
                sub.cohort || '',
                sub.employees || '',
                (sub.scores.overall_ssi * 100).toFixed(1),
                (sub.scores.pipeline * 100).toFixed(1),
                (sub.scores.conversion * 100).toFixed(1),
                (sub.scores.expansion * 100).toFixed(1),
                sub.answers.top_challenge || '',
                (sub.patterns || []).join('; ')
            ]);

            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `alpine-submissions-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Load submissions when page loads
        loadSubmissions();

        // Refresh every 30 seconds
        setInterval(loadSubmissions, 30000);
    </script>
</body>
</html>
